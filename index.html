<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const container = document.getElementById('job-listings-container');
    container.innerHTML = '<p id="loading-message">Fetching the latest jobs…</p>';

    const escapeHtml = s => String(s)
      .replaceAll('&','&amp;').replaceAll('<','&lt;')
      .replaceAll('>','&gt;').replaceAll('"','&quot;')
      .replaceAll("'","&#39;');
    const fmtDate = s => { const d = new Date(s); return isNaN(d) ? '—' : d.toLocaleDateString(); };

    try {
      const r = await fetch('/api/feed-jobs?limit=20');
      const data = await r.json();
      if (!r.ok || data.error) throw new Error(data.error || 'Feed error');

      const list = data.jobs || [];
      if (!list.length) {
        // fallback to live Adzuna if DB empty
        const live = await (await fetch('/api/fetch-jobs?limit=20')).json();
        render(live.jobs || []);
        return;
      }
      render(list);
    } catch (e) {
      container.innerHTML = `<p style="color:red"><strong>Error:</strong> ${e.message}</p>`;
    }

    function wageLabel(w) { return w ? `$${Number(w).toFixed(2)}/hr` : '—'; }

    function render(list) {
      container.innerHTML = '';
      list.forEach(job => {
        const url = job.apply_link || job.url;
        const created = job.created_at_external || job.created_at;
        const card = document.createElement('div');
        card.className = 'job-card';
        card.innerHTML = `
          <h2 class="job-title"><a href="${url}" target="_blank" rel="noopener">${escapeHtml(job.title || '')}</a></h2>
          <p class="job-company">${escapeHtml(job.company || '—')}</p>
          <p class="job-details"><strong>Location:</strong> ${escapeHtml(job.location || '—')}
             &nbsp;•&nbsp; <strong>Industry:</strong> ${escapeHtml(job.industry || '—')}
             &nbsp;•&nbsp; <strong>Wage:</strong> ${wageLabel(job.wage)}
             &nbsp;•&nbsp; <strong>Date:</strong> ${fmtDate(created)}</p>
          <div class="job-description">${escapeHtml(job.description || '')}</div>
        `;
        container.appendChild(card);
      });
    }
  });
</script>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TASK — Mercer County Jobs (Top 20)</title>
<meta name="description" content="Top 20 newest, entry-level friendly jobs around Mercer County for TASK patrons and staff." />
<style>
  :root{--bg:#f6f8fb;--card:#fff;--ink:#0f172a;--muted:#64748b;--brand:#0ea5e9;--border:#e5e7eb}
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:5;background:#ffffffcc;border-bottom:1px solid var(--border);backdrop-filter:blur(6px)}
  .wrap{max-width:1040px;margin:0 auto;padding:16px}
  h1{margin:0 0 4px;font-size:22px}
  .sub{margin:0;color:var(--muted);font-size:14px}
  .panel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:10px}
  .filters{display:grid;gap:8px;grid-template-columns:1fr 1fr 1fr 1fr auto}
  input,select,button{padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:#fff}
  button{background:var(--brand);color:#fff;border-color:var(--brand);font-weight:600;cursor:pointer}
  main{padding:16px 0 40px}
  .stats{display:grid;gap:10px;grid-template-columns:repeat(3,1fr);margin-bottom:12px}
  .stat{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
  .k{font-size:22px;font-weight:800}
  .lbl{font-size:12px;color:var(--muted)}
  .jobs{display:grid;gap:12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px}
  .ttl{margin:0 0 6px;font-size:18px;font-weight:700}
  .ttl a{color:#2563eb;text-decoration:none}
  .ttl a:hover{text-decoration:underline}
  .meta{font-size:13px;color:var(--muted);margin-bottom:8px}
  .desc{font-size:14px;color:#334155;line-height:1.45;display:-webkit-box;-webkit-line-clamp:6;-webkit-box-orient:vertical;overflow:hidden}
  .small{font-size:12px;color:var(--muted)}
  footer{padding:24px 0;color:var(--muted);text-align:center}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>TASK — Mercer County Jobs</h1>
    <p class="sub">Top 20 newest, entry-level friendly roles. Filter by keyword, location, industry, and minimum wage.</p>

    <!-- Filter bar -->
    <div class="panel">
      <div class="filters">
        <input id="kw" placeholder='Keywords (e.g., "warehouse", "entry level")' />
        <input id="loc" placeholder="Location (e.g., Trenton)" />
        <select id="industry">
          <option value="">All industries</option>
          <option>Warehouse</option>
          <option>Culinary</option>
          <option>Retail</option>
          <option>Healthcare</option>
          <option>Manufacturing</option>
        </select>
        <input id="minWage" type="number" step="0.01" placeholder="Min $/hr" />
        <button id="applyFilters">Filter</button>
      </div>
      <p class="small" style="margin-top:6px">Tip: Leave fields blank to see everything. “Min $/hr” filters out lower-paying roles.</p>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="stats">
      <div class="stat"><div class="k" id="kTotal">—</div><div class="lbl">Jobs</div></div>
      <div class="stat"><div class="k" id="kCompanies">—</div><div class="lbl">Unique Companies</div></div>
      <div class="stat"><div class="k" id="kIndustry">—</div><div class="lbl">Top Industry</div></div>
    </div>

    <section class="jobs" id="jobs">
      <div class="card"><div class="small">Loading the latest jobs…</div></div>
    </section>
    <!-- Table -->
<div class="panel" style="margin-top:16px">
  <h3 style="margin:6px 0 10px">Tabular view (Top 20)</h3>
  <div style="overflow:auto">
    <table id="jobsTable" style="width:100%; border-collapse:collapse">
      <thead>
        <tr style="text-align:left">
          <th style="padding:8px; border-bottom:1px solid #e5e7eb">Title</th>
          <th style="padding:8px; border-bottom:1px solid #e5e7eb">Company</th>
          <th style="padding:8px; border-bottom:1px solid #e5e7eb">Location</th>
          <th style="padding:8px; border-bottom:1px solid #e5e7eb">Industry</th>
          <th style="padding:8px; border-bottom:1px solid #e5e7eb">Wage</th>
          <th style="padding:8px; border-bottom:1px solid #e5e7eb">Date</th>
        </tr>
      </thead>
      <tbody id="jobsTbody"></tbody>
    </table>
  </div>
</div>

<!-- Charts -->
<div class="panel" style="margin-top:16px">
  <h3 style="margin:6px 0 10px">Quick charts</h3>
  <div style="display:grid; gap:16px; grid-template-columns:1fr 1fr">
    <canvas id="chartIndustry" height="140"></canvas>
    <canvas id="chartWage" height="140"></canvas>
  </div>
</div>

  </div>
</main>

<footer>
  <div class="wrap small">Data source: Supabase (approved jobs). Transit link starts at TASK, Trenton NJ.</div>
</footer>

<script>
  // ───────────────────────────
  // Your Supabase info (works on GitHub Pages)
  // ───────────────────────────
  const SUPABASE_URL  = 'https://yamqxbmckcaaltswxmny.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhbXF4Ym1ja2NhYWx0c3d4bW55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMTcxODEsImV4cCI6MjA3NTY5MzE4MX0.KqBwtiCFsu6mwFqiSIV5wmuh7C00-uPK4CADY29r0ws';

  // UI elements
  const jobsEl = document.getElementById('jobs');
  const kTotal = document.getElementById('kTotal');
  const kCompanies = document.getElementById('kCompanies');
  const kIndustry = document.getElementById('kIndustry');
  const kw = document.getElementById('kw');
  const loc = document.getElementById('loc');
  const ind = document.getElementById('industry');
  const mw  = document.getElementById('minWage');
  const applyBtn = document.getElementById('applyFilters');

  // Helpers
  const escapeHtml = s => String(s)
    .replaceAll('&','&amp;').replaceAll('<','&lt;')
    .replaceAll('>','&gt;').replaceAll('"','&quot;')
    .replaceAll("'","&#39;");
  const fmtDate = s => { const d = new Date(s); return isNaN(d) ? '—' : d.toLocaleDateString(); };
  const wageLabel = w => w ? `$${Number(w).toFixed(2)}/hr` : '—';
  const TASK_ADDR = 'Trenton Area Soup Kitchen, 72 Escher St, Trenton, NJ 08609';
  const mapsTransit = (dest) => {
    const p = new URLSearchParams({ api:'1', origin:TASK_ADDR, destination:dest||'', travelmode:'transit' });
    return `https://www.google.com/maps/dir/?${p.toString()}`;
  };
  function topKey(arr){
    const m = new Map();
    for (const k of arr) m.set(k, (m.get(k)||0)+1);
    let best=null, cnt=0;
    for (const [k,v] of m) if (v>cnt){best=k;cnt=v;}
    return best;
  }

  applyBtn.addEventListener('click', loadJobs);
  document.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') loadJobs(); });
  document.addEventListener('DOMContentLoaded', loadJobs);

  async function loadJobs(){
    jobsEl.innerHTML = '<div class="card"><div class="small">Loading…</div></div>';

    // Build Supabase REST query
    const p = new URLSearchParams();
    p.set('select', [
      'id','title','company','industry','location',
      'wage','apply_link','description',
      'created_at','created_at_external','approved'
    ].join(','));
   p.set('order','created_at_external.desc,created_at.desc');
    p.set('limit','20');

    // Only show approved rows (safe for public)
    p.set('approved','is.true');

    // Filters
    const qv = kw.value.trim();
    const lv = loc.value.trim();
    const iv = ind.value;
    const mv = mw.value;

    if (iv) p.set('industry', `eq.${iv}`);
if (mv) p.set('wage', `gte.${mv}`);
if (lv) p.set('location', `ilike.*${lv}*`);
if (qv) p.set('or', `(title.ilike.*${qv}*,company.ilike.*${qv}*,industry.ilike.*${qv}*,location.ilike.*${qv}*)`);

    // Debug line—should show your .supabase.co URL
    console.log('Fetching:', `${SUPABASE_URL}/rest/v1/jobs?${p}`);

    try{
      const r = await fetch(`${SUPABASE_URL}/rest/v1/jobs?${p.toString()}`, {
        headers: { apikey: SUPABASE_ANON, Authorization: `Bearer ${SUPABASE_ANON}` }
      });
      if (!r.ok) throw new Error(await r.text());
      const list = await r.json();
      render(list);
    }catch(e){
      jobsEl.innerHTML = `<div class="card"><div class="small" style="color:#b91c1c">Error: ${escapeHtml(e.message)}</div></div>`;
    }
  }
  // ---- table
const tbody = document.getElementById('jobsTbody');
tbody.innerHTML = '';
for (const j of list) {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td style="padding:8px; border-bottom:1px solid #f1f5f9"><a href="${j.apply_link || '#'}" target="_blank" rel="noopener">${escapeHtml(j.title || '')}</a></td>
    <td style="padding:8px; border-bottom:1px solid #f1f5f9">${escapeHtml(j.company || '')}</td>
    <td style="padding:8px; border-bottom:1px solid #f1f5f9">${escapeHtml(j.location || '')}</td>
    <td style="padding:8px; border-bottom:1px solid #f1f5f9">${escapeHtml(j.industry || '')}</td>
    <td style="padding:8px; border-bottom:1px solid #f1f5f9">${wageLabel(j.wage)}</td>
    <td style="padding:8px; border-bottom:1px solid #f1f5f9">${fmtDate(j.created_at_external || j.created_at)}</td>
  `;
  tbody.appendChild(tr);
}

// ---- charts
const byIndustry = {};
const wages = [];
for (const j of list) {
  const key = j.industry || '—';
  byIndustry[key] = (byIndustry[key] || 0) + 1;
  if (j.wage != null) wages.push(Number(j.wage));
}

// destroy old charts if they exist
window._chartIndustry?.destroy();
window._chartWage?.destroy();

const ctx1 = document.getElementById('chartIndustry');
window._chartIndustry = new Chart(ctx1, {
  type: 'bar',
  data: {
    labels: Object.keys(byIndustry),
    datasets: [{ label: 'Jobs', data: Object.values(byIndustry) }]
  },
  options: { responsive: true, plugins: { legend: { display: false } } }
});

const bins = [0,10,12,15,18,20,25,30,40,60,1000]; // hourly bands
const counts = Array(bins.length - 1).fill(0);
for (const w of wages) {
  for (let i=0;i<bins.length-1;i++){
    if (w >= bins[i] && w < bins[i+1]) { counts[i]++; break; }
  }
}
const labels = bins.slice(0, -1).map((b,i)=> `$${b}–${bins[i+1]-0.01}`);
const ctx2 = document.getElementById('chartWage');
window._chartWage = new Chart(ctx2, {
  type: 'bar',
  data: { labels, datasets: [{ label: 'Roles', data: counts }] },
  options: { responsive: true, plugins: { legend: { display: false } } }
});


  function render(list){
    // Stats
    kTotal.textContent = String(list.length || 0);
    kCompanies.textContent = String(new Set(list.map(j => (j.company || '—'))).size);
    kIndustry.textContent = topKey(list.map(j => j.industry || '—')) || '—';

    if (!list.length){
      jobsEl.innerHTML = '<div class="card"><div class="small">No jobs match those filters. Try clearing one or two fields.</div></div>';
      return;
    }

    jobsEl.innerHTML = '';
    for (const job of list){
      const url = job.apply_link || '#';
      const created = job.created_at_external || job.created_at;
      const card = document.createElement('article');
      card.className = 'card';
      card.innerHTML = `
        <h3 class="ttl"><a href="${url}" target="_blank" rel="noopener">${escapeHtml(job.title || '')}</a></h3>
        <div class="meta">
          ${escapeHtml(job.company || '—')} ·
          ${escapeHtml(job.location || '—')} ·
          ${escapeHtml(job.industry || '—')} ·
          ${fmtDate(created)}
        </div>
        <div class="desc">${escapeHtml(job.description || '')}</div>
        <div class="meta" style="margin-top:8px">
          <strong>Wage:</strong> ${wageLabel(job.wage)} &nbsp;•&nbsp;
          <a href="${mapsTransit(job.location)}" target="_blank" rel="noopener">Transit from TASK</a>
        </div>
      `;
      jobsEl.appendChild(card);
    }
  }
</script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

</body>
</html>
